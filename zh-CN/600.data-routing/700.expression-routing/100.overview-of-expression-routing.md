# 分区表达式路由

本文主要介绍分区表达式的支持情况以及如何使用。

## 背景

OceanBase 数据库是分布式数据库, 每个表甚至每个表的不同分区都可能存放在不同的机器上，若要对表进行读写，就必须先要定位到数据所属的表或是分区的位置。尽管任何一台 OBServer 节点均拥有路由转发和本地执行的功能，但实际场景中，这样做将严重影响性能和整体吞吐量。

ODP 作为 OceanBase 数据库的高性能反向代理服务器，其核心功能就是路由转发，因此若 ODP 支持更多的表达式解析，就可以实现将具体 SQL 转发的最恰当的 OBServer 节点上执行，从而减少慢查询的出现次数，提升用户体验。

## 使用说明

* 分区表达式路由为 ODP V4.2.3 跌打功能，使用该功能时需确保您所使用的 ODP 为 V4.2.3 或之后版本。

* 表达式不支持的场景仅代表 ODP 无法准确路由，会随机发给 OBServer 节点，但是这些函数的功能本身 OceanBase 数据库是支持的。

* ODP 计算分区键的目的在于准确路由用户的请求，ODP 分区路由的错误不影响请求执行的正确性。

<!-- * ODP 的 SQL 解析器只能针对 SQL 做简单的解析，在部分场景下（比如嵌套查询），分区键计算可能会有不准确的情况，这里推荐使用案例中的用法，同时使用2.3.1中描述的路由诊断功能验证当前sql是否能否准确计算 -->

## 支持情况
<!-- 各个表达式需重新梳理一遍 -->
ODP 分区表达式路由支持分区键、默认值以及生成列，下文将分别为您介绍。

### 分区键和默认值

本节介绍分区键和默认值中支持的表达式，ODP 支持基本的四则运算（包括 `+`、`-`、`*`、`/`），除此之外还支持字符串表达式、数字计算表达式和日期表达式。本节将分别介绍 ODP 对各表达式的支持情况，详细的使用介绍可参见下文 [使用说明](#使用说明)。

#### 字符串表达式

ODP 对字符串表达式的支持情况见下表。

|      表达式       |                    功能                    |   支持模式   |
|-------------------|-------------------------------------------|--------------|
| SUBSTR            | 从字符串中提取子串                         | MySQL/Oracle |
| TO_CHAR(datetime) | 将 datetime 类型数据转为 char 类型         | Oracle       |
| LOWER/LCASE       | 将字符转为小写格式                         | MySQL/Oracle |
| UPPER/UCASE       | 将字符转为大写格式                         | MySQL/Oracle |
| TRIM              | 移除字符串两侧（或指定一侧）的指定字符       | MySQL/Oracle |
| LTRIM             | 移除字符串左侧的指定字符                   | MySQL/Oracle |
| RTRIM             | 移除字符串右侧的指定字符                   | MySQL/Oracle |
| CONCAT            | 将一个或多个字符串连接成一个新的单一字符串   | MySQL/Oracle |
| SUBSTRING         | 从字符串中提取子串                         | MySQL        |
| REPLACE           | 将字符串中的某个子串替换为另一个子串         | MySQL/Oracle |
| LENGTH            | 计算字符串的长度                           | MySQL/Oracle |

#### 数字计算操作

| 表达式                             | 说明                     | 支持模式     |
|-----------------------------------|--------------------------|--------------|
| MOD                               | 返回两个数相除后的余数     | Oracle       |
| NVL                               | 用于处理 NULL 值          | Oracle       |
| ISNULL                            | 返回值为 1/0              | MySQL        |
| ABS                               | 返回其参数的绝对值         | MySQL/Oracle |
| CEIL/CEILING                      | 返回大于或等于其参数的最小整数  | MySQL/Oracle |
| FLOOR                             | 返回小于或等于其参数的最大整数  | MySQL/Oracle |
| TRUNCATE(MySQL)</br>TRUNC(Oracle) | 对数字进行截断处理（不进行四舍五入）           | MySQL/Oracle |
| ROUND                             | 对数值进行四舍五入，详细介绍可参见《OceanBase 数据库》手册中 [ROUND（MySQL 模式）](https://www.oceanbase.com/docs/common-oceanbase-database-cn-1000000000222598) 和 [ROUND（Oracle 模式）](https://www.oceanbase.com/docs/common-oceanbase-database-cn-1000000000222428) 介绍                | MySQL/Oracle |

#### 日期计算操作

|        表达式         |                    说明                     | 支持模式 |
|-----------------------|--------------------------------------------|---------|
| CURDATE/CURRENT_DATE  | 当前时区日期，不含时间部分                   | MySQL    |
| CURTIME/CURRENT_TIME  | 当前时区时间，不含日期部分                   | MySQL    |
| CURRENT_TIMESTAMP/NOW | 当前时区的日期时间                          | MySQL    |
| CURRENT_DATE          | 当前会话时区中的当前日期                    | Oracle   |
| CURRENT_TIMESTAMP     | 当前会话时区的当前日期                      | Oracle   |
| SYSTIMESTAMP          | 数据库服务器操作系统日期（timestamp）       | Oracle   |
| SYSDATE               | 数据库服务操作系统日期（date）              | Oracle   |
| TO_DATE               | 将字符串转换为日期或日期时间类型数据         | Oracle   |
| TO_TIMESTAMP          | 将字符串转换为 timestamp 类型的日期时间数据  | Oracle   |

<!-- #### 使用示例

**分区键场景**

1. 创建数据库 test1

   ```shell
   create table partition_test1 (
     c1 int,
     c2 int
   ) partition by hash(c1) partitions 3;
   ```

2. 查看 test1 表中 c1 列为 1 的数据

   ```shell
   select * from partition_test1 where c1 = nvl(null, 1);
   ```

**默认值场景** -->

### 生成列

目前仅支持 SUBSTR 表达式，且有如下两条注意事项：

* 生成列以及对应的源列的类型需要是字符串类型，比如 varchar、text 等。

* 生成列的 SUBSTR 函数计算暂时不支持使用 multi-char 字符做计算。

使用场景如下：

```shell
create table partition_test2(
  c1 varchar2(20) default 'aaaaaaaaaaaa',
  c2 varchar2(20) GENERATED ALWAYS AS (substr(c1, 1, 4))
) partition by hash(c2) partitions 3;
```

## 使用说明

本节根据不同的表达式分别介绍具体使用方法。

### 基本表达式

目前 ODP 支持在分区键以及默认值中使用四则运算嵌套表达式，在使用功能带有函数的四则运算时，您需注意使用函数的支持情况。

使用示例如下：
<!-- 这里的分区键是指应用到那一块儿啊 -->
* 分区键
  
  此处假设数据库中存在表 `test1`，查看 `test1` 表中符合条件的数据。
  
  ```shell
  select * from t1 where c1 = ((((-(2)*(2-4)) +mod(mod((1+(3*2)),2),1)) -(4/2))+ mod(1,2));
  ```

* 默认值
  
  创建表 `test2`，并通过表达式定义列 `c1`。

  ```shell
  CREATE TABLE test1(
    c1 number default mod(5,2)+1,
    c2 int
  )
  PARTITION BY HASH (c1) PATITIONS 3;
  ```
