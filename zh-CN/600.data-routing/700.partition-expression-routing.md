# 分区表达式路由

本文主要介绍分区表达式的支持情况以及如何使用。

## 背景

OceanBase 数据库是分布式数据库, 每个表甚至每个表的不同分区都可能存放在不同的机器上，若要对表进行读写，就必须先要定位到数据所属的表或是分区的位置。尽管任何一台 OBServer 节点均拥有路由转发和本地执行的功能，但实际场景中，这样做将严重影响性能和整体吞吐量。

ODP 作为 OceanBase 数据库的高性能反向代理服务器，其核心功能就是路由转发，因此若 ODP 支持更多的表达式解析，就可以实现将具体 SQL 转发的最恰当的 OBServer 节点上执行，从而减少慢查询的出现次数，提升用户体验。

## 支持情况
<!-- 生成列 和 分区键 以及表达式之间的关系是什么 -->
ODP 支持基本的四则运算（包括 `+`、`-`、`*`、`/`），除此之外还支持字符串表达式、数字计算表达式和日期表达式。本节将分别介绍 ODP 对各表达式的支持情况，详细的示例可参见下文 [使用说明](#使用说明)。

### 字符串表达式

ODP 对字符串表达式的支持情况见下表。

|      表达式       |           功能            |   支持模式   |
|-------------------|--------------------------|--------------|
| SUBSTR            | 支持字符串的分割          | MySQL/Oracle |
| TO_CHAR(datetime) | 支持datetime转为char类型  | Oracle       |
| LOWER/LCASE       | 转小写                    | MySQL/Oracle |
| UPPER/UCASE       | 转大写                    | MySQL/Oracle |
| TRIM              | 删除开头和末尾空格         | MySQL/Oracle |
| LTRIM             | 删除左侧空格              | MySQL/Oracle |
| RTRIM             | 删除右侧空格              | MySQL/Oracle |
| CONCAT            | 拼接字符串                | MySQL/Oracle |
| SUBSTRING         | 子串                     | MySQL        |
| REPLACE           | 替换字符串                | MySQL/Oracle |
| LENGTH            | 计算字节长度              | MySQL/Oracle |

### 数字计算操作

| 表达式                            | 说明                     | 支持模式     |
|-----------------------------------|-------------------------|---------------|
| MOD                               | 取余                     | Oracle       |
| NVL                               | 是否为null               | Oracle       |
| ISNULL                            | 返回值为1/0              | MySQL        |
| ABS                               | 绝对值                   | MySQL/Oracle |
| CEIL/CEILING                      | 大于等于目标值的最小整数  | MySQL/Oracle |
| FLOOR                             | 小于等于目标值的最大整数  | MySQL/Oracle |
| TRUNCATE(MySQL)</br>TRUNC(Oracle) | 按精度截取数字           | MySQL/Oracle |
| ROUND                             | 四舍五入                 | MySQL/Oracle |

### 日期计算操作

|        表达式          |                说明               | 支持模式 |
|-----------------------|-----------------------------------|----------|
| CURDATE/CURRENT_DATE  | 当前时区日期，不含时间部分          | MySQL    |
| CURTIME/CURRENT_TIME  | 当前时区时间，不含日期部分          | MySQL    |
| CURRENT_TIMESTAMP/NOW | 当前时区的日期时间                  | MySQL    |
| CURRENT_DATE          | 当前会话时区中的当前日期            | Oracle   |
| CURRENT_TIMESTAMP     | 当前会话时区的当前日期              | Oracle   |
| SYSTIMESTAMP          | 数据库服务器操作系统日期(timestamp) | Oracle   |
| SYSDATE               | 数据库服务操作系统日期(date)        | Oracle   |
| TO_DATE               | 字符串转date                        | Oracle   |
| TO_TIMESTAMP          | 字符串转timestamp                   | Oracle   |

## 使用前配置

使用分区表达式路由功能需配置 `enable_qa_mode` 和 `location_expire_period` 配置项，配置项的详细介绍可参见 [enable_qa_mode](../400.configuration-management/200.dynamically-effective/740.enable-qa-mode.md) 和 [location_expire_period]()。操作步骤如下：
<!-- 配置项链接待补充 -->
1. 使用 root@sys 用户通过 ODP 代理登录 OceanBase 数据库，或使用 root@proxysys 用户登录 ODP

   使用 root@sys 用户登录 OceanBase 数据库示例如下，详细参数介绍可参见《OceanBase 数据库》文档 [通过 OBClient 连接 OceanBase 租户](https://www.oceanbase.com/docs/common-oceanbase-database-cn-1000000000218474)。

   ```shell
   [admin@obtest ~]$ obclient -uroot@sys#obcluster -h10.10.10.1 -P2883 -p
   ```

   <main id="notice" type='notice'>
     <h4>注意</h4>
     <p>若要在 OceanBase 数据库中使用 ODP 命令，连接 OceanBase 数据库的连接 IP（<code>-h</code>）和连接端口（<code>-P</code>）需为 ODP 的地址和监听端口（<code>listen_port</code>）</p>
   </main>

   使用 root@proxysys 用户登录 ODP 示例如下，此处的连接 IP（`-h`）为 ODP 的地址，连接端口（`-P`）为 ODP 的监听端口（`listen_port`）。

   ```shell
   [admin@obtest ~]$ obclient -uroot@proxysys -h10.10.10.1 -P2883 -p
   ```

2. 执行如下命令配置 `enable_qa_mode` 为 `True`

   ```shell
   [admin@obtest ~]$ alter proxyconfig set enable_qa_mode=True;
   ```

3. 执行如下命令配置 `location_expire_period` 为 `1`
   <!-- 该配置项需介绍 -->

   ```shell
   [admin@obtest ~]$ alter proxyconfig set location_expire_period=1;
   ```

## 使用说明

本节根据不同的表达式分别介绍具体使用方法。

<main id="notice" type='explain'>
  <h4>说明</h4>
  <p>表达式不支持的场景仅代表 ODP 无法准确路由，会随机发给 OBServer 节点，但是这些函数的功能本身 OceanBase 数据库是支持的。</p>
</main>

### 字符串表达式

本节介绍字符串表达式中各个表达式的使用示例。

