# 性能分析

## 基础理论

### 性能调优

性能调优旨在充分发挥软件和硬件的能力，在真实环境中实现系统的最佳性能，提高软硬件的性价比，降低客户的成本。如下所示，通过 `perf stat` 命令可采集一段时间硬件性能指标数据。

```bash
 Performance counter stats for process id '3260':

     182250.331423      task-clock (msec)         #   18.221 CPUs utilized
         3,259,379      context-switches          #    0.018 M/sec
         1,628,966      cpu-migrations            #    0.009 M/sec
                51      page-faults               #    0.000 K/sec
   442,995,845,816      cycles                    #    2.431 GHz
   226,812,458,841      instructions              #    0.51  insn per cycle
    45,556,284,037      branches                  #  249.965 M/sec
       662,510,643      branch-misses             #    1.45% of all branches

      10.002402740 seconds time elapsed
```

### 性能调优步骤

性能调优主要步骤如下所示：

1. 确定优化目标

   1. 吞吐量：吞吐量主要关注 CPU 信息和组件瓶颈，目前 ODP 和 OBServer 都可以将 CPU 跑满

   2. 延迟：需要关注访问链路上组件数量和每一段耗时，网络延迟也是重要因素

   3. 经验：从全局考虑，越靠近业务测优化效果可能更明显

2. 压力测试及信息采集：除了采集目标数据，还需要采集每个组件的 CPU 消耗、网络延迟等数据

3. 分析压力确定性能瓶颈：通过上面采集数据，先确定导致瓶颈点的组件，再继续细致分析

4. 实施优化：目前优化主要是调整参数、调整部署等，特殊情况需要修改代码发版本解决

5. 确认优化效果：主要关注延迟和吞吐量是否满足客户要求或测试成绩
