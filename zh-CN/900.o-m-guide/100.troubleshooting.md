# 问题排查思路

本文将介绍一些问题排查的规范和思路，方便大家在使用过程中解决问题。

## 描述问题

遇到问题时，首先需要清楚地描述问题，比如在 OceanBase 开源社区 [问答模块](https://ask.oceanbase.com/)，描述问题模板如下：

```bash
【 使用环境 】生产环境 or 测试环境
【 OB or 其他组件 】
【 使用版本 】
【问题描述】清晰明确描述问题
【复现路径】问题出现前后相关操作
【问题现象及影响】

【附件】
```

这里也推荐大家按照上述模板要求填写，填写相关内容也利于大家将问题想的更清楚。对于问题描述部分，可以包含以下两点：

* 问题时间：对于不好复现问题，时间信息有利于进行问题梳理，方便对齐问题

* 客户端报错：客户端报错包含丰富的信息（SQL、堆栈、执行时间等），对排查问题非常有帮助；当有结论时，也可以前后对照，进一步验证结论

## 分析问题

描述完问题后，对于问题排查人员来说需要分析问题。在分析问题前，首先要全局了解数据库访问链路，主要包含以下模块：

* 应用

* Load Balance（LB）

* ODP

* OceanBase 数据库

从全局再去看局部，思路会更清晰，ODP 和各个模块都有交互，大家有空也可以多学习下应用、LB 和 OceanBase 数据库的知识。

当分析问题时，按照从前往后（从应用端开始）的顺序一个个分析，先确定哪个模块的问题，再确定模块的具体问题。

下面再介绍一些低效的问题排查方法，大家尽量避免：

* 出现应用使用数据库报错的问题，直接去 ODP 的日志目录搜索 WARN 和 ERROR 级别日志，如果日志打印不规范或者 WARN/ERROR 日志太多，这种方法就十分的低效，甚至和问题没任何关系。

* 出现数据库连接中断的问题，跳过中间环节，直接从 OceanBase 数据库开始排查，结果未发现问题。

## 归类问题

本小节对 ODP 常见问题进行归类，方便大家在分析 ODP 模块时有更好的思路。从业务视角去看，ODP 的问题主要包含以下几类：

* 登录失败：绝大部分都是某个地方配置出现问题，比较容易复现和排查

* SQL 执行
  
  * 返回错误：后端服务返回明确的错误码，根据错误码去 OBServer 节点和 ODP 端排查
  
  * 慢 SQL：需要确定每个模块的耗时，找到瓶颈点去优化
  
  * 断连接：和慢 SQL 类似，需要先排查哪个模块主动断开连接（主动发送 FIN 报文），然后排查具体模块

    * 超时断连

    * 异常断连

## 解决问题

解决 ODP 的问题时，有三大法宝：ODP 日志、Linux 命令（网络命令、系统命令和文本命令）和监控平台 OCP。

* ODP 日志的详细信息可参见本手册 [日志](../../650.log/100.overview-of-logs.md) 章节。

* Linux 命令的知识点十分通用，网络上资料很多，大家可以自行学习，掌握后对大家排查问题帮助很大。

* 监控平台 OCP 的详细信息可参见 [云平台 OCP](https://www.oceanbase.com/docs/ocp) 手册。

### Prometheus

ODP 除了提供日志系统外，还提供 Prometheus 系统，以便对接不同的监控平台。Prometheus 系统提供总的请求数量、执行耗时、当前前端连接数、后端连接数等信息。具体监控项如下表所示：

|  监控项               |  是否必选  | 描述                   |
|-----------------------|-----------|------------------------|
| odp_transaction_total | 是        |  总事务数               |
| odp_sql_request_total | 是        |  总请求数               |
| odp_sql_cost_total    | 是        |  请求总耗时             |
| odp_current_session   | 是        |  当前 session 数量      |
| odp_entry_total       | 否        |  table entry 请求数量   |
| odp_request_byte      | 否        |  请求字节数             |