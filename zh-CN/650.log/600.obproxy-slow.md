# obproxy_slow.log
<!-- 自己部署的环境中,该日志没有内容,无法验证是否有变动 -->
obproxy_slow.log 日志是慢 SQL 请求日志，记录执行时间大于参数 `slow_query_time_threshold` 阈值（默认 500ms）的请求。
<!-- ,,,0,11.xxx.xxx.53:33041 -->
* 日志格式

  ```bash
  日志打印时间,当前应用名,TraceId,RpcId,逻辑数据源名称,物理库信息(cluster:tenant:database),数据库类型(OB/RDS),逻辑表名,物理表名,SQL 命令,SQL 类型(CRUD),执行结果(success/failed),错误码(success 时为空),SQL,执行总耗时(us),预执行时间,链接建立时间,数据库执行时间,当前线程名,系统穿透数据,穿透数据
  ```
  <!-- 示例中对比着查看,线程名后还有五个字段,但是格式介绍里,线程名后只有两个字段含义-->
  说明：
  
  * `SQL 命令` 显示为 COM_QUERY、COM_STMT_PREPARE 等。

  * `执行总耗时` 包括内部 SQL 执行耗时。

  * `当前线程名` 显示 ODP 的内部线程 ID。

  * `系统穿透数据` 将显示系统灾备信息等。

* 日志示例

  ```bash
  2022-07-11 14:32:51.758270,undefined,,,,obcluster:sys:test,OB_MYSQL,,,COM_QUERY,SELECT,success,,select sleep(3),3041116us,409us,0us,3039883us,Y0-7F4B1CEA13A0,,,,0,11.xxx.xxx.53:33041
  ```

对于慢 SQL，在 obproxy.log 中也会有记录，关键字是 `Slow Query`，obproxy.log 中记录的信息更加详细，如执行 SQL 语句 `select sleep(3) from dual`，搜索 obproxy.log 将得到：
<!-- obproxy.log 中包含哪些记录,可以列举么,比如慢SQL 记录/登录记录/启动记录-->
```bash
[2022-07-11 14:32:51.758195] WARN  [PROXY.SM] update_cmd_stats (ob_mysql_sm.cpp:8425) [74744][Y0-7F4B1CEA13A0] [lt=7] [dc=0] Slow Query: ((
client_ip={127.0.0.1:50422},   // 执行 SQL client IP
server_ip={11.xxx.xxx.53:33041}, // SQL 被路由到的目标 OBServer 节点
obproxy_client_port={100.xxx.xxx.179:52052},  // 和 OceanBase 数据库连接的客户端地址
server_trace_id=Y81100B7C0535-0005E3460FBBE3CD-0-0, // 目标 OBServer 节点中执行过程中的 trace id
route_type=ROUTE_TYPE_NONPARTITION_UNMERGE_LOCAL, // SQL 使用的路由策略
user_name=root,         // 用户名
tenant_name=sys,        // 租户名
cluster_name=obcluster,  // 集群名
logic_database_name=,  // 逻辑库名
logic_tenant_name=,    // 逻辑租户名
ob_proxy_protocol=0,   // 协议类型
cs_id=14,         // client login 时看到的 connection id, ODP 分配
proxy_sessid=7230691598940700681, // client 访问 OceanBase 时内部记录 connection id
ss_id=21, 
server_sessid=3221588238,  // SQL 在目标 OBServer 节点中的 connection id, OBServer 节点分配
sm_id=14, 
cmd_size_stats={
    client_request_bytes:20,  // client 发给 ODP 的请求包大小
    server_request_bytes:38,  // ODP 发给目标 OBServer 节点的请求包大小
    server_response_bytes:0,  // 目标 OBServer 节点发给 ODP 的响应包大小
    client_response_bytes:71}, // ODP 发给 client 的响应包大小
cmd_time_stats={
    client_transaction_idle_time_us=0, // 在事务中该条 SQL 与上一条 SQL 执行结束之间的间隔时间, 即 client 事务间隔时间
    client_request_read_time_us=97, // ODP 从 client socket 读取请求包的耗时
    client_request_analyze_time_us=95, // ODP 分析 client 的 SQL 耗时
    cluster_resource_create_time_us=0, // ODP 创建集群资源耗时(仅首次访问集群时需要创建)
    pl_lookup_time_us=0, // 根据 SQL 获取涉及路由表的耗时
    pl_process_time_us=0,  // 对涉及路由表的进行筛选排序的耗时
    congestion_control_time_us=21,  // 根据 SQL 获取涉及黑名单信息的耗时
    congestion_process_time_us=3,  // 对涉及黑名单的进行检查过滤的耗时
    do_observer_open_time_us=55,  // 对目标 OBServer 节点获取可用连接的耗时, 包含 connect_time
        server_connect_time_us=0,  // 对目标 OBServer 节点创建连接的耗时
    server_sync_session_variable_time_us=0,  // 对选择的目标连接进行初始化的耗时, 包括 saved_login, 同步 db, 同步系统变量, 同步 last_insert_id, 同步 start_trans
        server_send_saved_login_time_us=0,  // 对选择的目标连接进行 saved login 耗时
        server_send_use_database_time_us=0,  // 对选择的目标连接同步 db 耗时
        server_send_session_variable_time_us=0,  // 对选择的目标连接同步已修改的系统变量耗时
        server_send_all_session_variable_time_us=0,  // 对选择的目标连接同步所有系统耗时
        server_send_last_insert_id_time_us=0, // 对选择的目标连接同步 last_insert_id 耗时
        server_send_start_trans_time_us=0,   // 对选择的目标连接同步 start_trans/begin 耗时
    build_server_request_time_us=23,  // 构建对目标 Server 的请求包的耗时
    plugin_compress_request_time_us=0,   // 对请求包进行压缩耗时
    prepare_send_request_to_server_time_us=409,  // ODP 接受到客户端请求，到转发到 OBServer 节点执行前总计时间，正常应该是前面所有时间之和
    server_request_write_time_us=32,  // ODP 向目标 server socket 发送请求包的耗时
    server_process_request_time_us=3039883,   // 目标 Server 该执行 SQL 的耗时
    server_response_read_time_us=67,   // ODP 从目标 server socket 读取响应包的耗时
    plugin_decompress_response_time_us=59, // 对响应包进行解压缩耗时
    server_response_analyze_time_us=70,  // 对响应包进行分析的耗时
    ok_packet_trim_time_us=0, // 对响应包 trim 掉最后一个 ok 包的耗时
    client_response_write_time_us=185,  // ODP 向 client socket 发送响应包的耗时
    request_total_time_us=3041116},  // ODP 处理该请求总时间, 等于前面所有耗时之和
sql=select sleep(3)   //client 的请求 SQL
))
```

## 相关文档

slow_query_time_threshold 配置项的详细介绍可参见 [slow_query_time_threshold](../400.configuration-management/200.dynamically-effective/2350.slow-query-time-threshold.md)。
