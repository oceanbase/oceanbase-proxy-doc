# obproxy_error.log

obproxy_error.log 日志是 ODP 错误日志，执行错误的请求会打印到该日志中，包括 ODP 自身错误和 OceanBase 数据库返回错误。

* 日志格式

  ```bash
  日志打印时间,当前应用名,TraceId,RpcId,逻辑数据源名称,物理库信息(cluster:tenant:database),数据库类型(OB/RDS),逻辑表名,物理表名,SQL 命令,SQL 类型(CRUD),执行结果(success/failed),错误码(success 时为空),SQL,执行总耗时(us),预执行时间,链接建立时间,数据库执行时间,当前线程名,系统穿透数据,穿透数据,错误详情
  ```

  说明：
  
  * `SQL 命令` 显示为 COM_QUERY、COM_STMT_PREPARE 等。

  * `执行总耗时` 包括内部 SQL 执行耗时。

  * `当前线程名` 显示 ODP 的内部线程 ID。

  * `系统穿透数据` 将显示系统灾备信息等。

* 日志示例
  
  此处以 `select obproxy_error from dual` 命令做测试，其中 `obproxy_error` 字段没有加引号，会被当作列处理，导致执行失败。客户端报错如下

  ```sql
  MySQL [test]> select obproxy_error from dual;
  ERROR 1054 (42S22): Unknown column 'obproxy_error' in 'field list'
  ```

  打开 obproxy_error.log，内容如下：

  ```bash
  2022-07-11 10:26:09.358231,undefined,,,,obcluster:sys:test,OB_MYSQL,,,COM_QUERY,SELECT,failed,1054,select obproxy_error from dual,42423us,454us,0us,41222us,Y0-7F4B1EF653A0,,,,0,11.xxx.xxx.53:33041,Unknown column 'obproxy_error' in 'field list'

  # 日志分析
  1,2022-07-11 10:26:09.358231    #日志打印时间
  2,undefined           # 无需关注，内部使用
  3,                    # 无需关注，内部使用
  4,                    # 无需关注，内部使用
  5,                    # 无需关注，内部使用
  6,obcluster:sys:test  # 物理库信息（cluster:tenant:database）
  7,OB_MYSQL         # 数据库类型
  8,                 # 逻辑表名
  9,                 # 物理表名
  10,COM_QUERY       # SQL 命令（COM_QUERY、COM_STMT_PREPARE 等）
  11,SELECT          # SQL 类型
  12,failed          # 执行结果（success/failed）
  13,1054            # 错误码（success 时为空）
  14,select obproxy_error from dual  # SQL 语句
  15,42423us         # 执行总耗时（包括内部 SQL 执行耗时）
  16,454us           # 预执行时间
  17,0us             # 建立连接时间
  18,41222us         # 数据库执行时间
  19,Y0-7F4B1EF653A0 # ODP 内部日志 trace_id
  20,           # 无需关注，内部使用
  21,           # 无需关注，内部使用
  22,           # 无需关注，内部使用
  23,0          # 无需关注，内部使用
  24,11.xxx.xxx.53:33041  # 路由到的 OceanBase 数据库的地址信息
  25,Unknown column 'obproxy_error' in 'field list' # 报错信息
  ```

  从第 12 行可以看到执行失败，从第 24 行可以看到执行 SQL 的 OBServer 节点的地址信息，第 25 行有报错信息，就可以确定时数据库执行失败。
