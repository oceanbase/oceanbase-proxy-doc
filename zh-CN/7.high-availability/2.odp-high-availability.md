# ODP 服务高可用

ODP 服务的高可用是指 ODP 本身能够连续提供服务，降低故障对代理服务影响。但这会受以下三个因素影响。

* 因素 1：部署 ODP 的机器是否正常，比如该机器是否可以和其他机器正常通信、机器是否发生了宕机。

* 因素 2：ODP 进程是否可以稳定运行并正常提供服务，以及进程被误杀后是否可以及时拉起。

* 因素 3：ODP 依赖的第三方模块如 OCP 和 OBServer 是否正常提供服务，比如 OCP 是否可以正常提供 HTTP 服务。

接下来分别就这三个因素介绍 ODP 服务的高可用。

## 部署机器异常

ODP 的部署方式可参考 [部署方式](../2.install/3.deploy.md) 一文，本节通过分析应用端部署和独立部署（OBServer 端部署与其类似）两种情况下的机器故障介绍 ODP 服务高可用。

应用端部署时，ODP 和业务软件部署在同一台机器上，当业务机器出现问题后，软件和 ODP 都会受到影响，需要业务层和 ODP 一起实现高可用特性，常见方法有：

* 故障探测：通过第三方系统进行探测、监控、巡检等发现业务服务异常，触发自愈流程后 SRE 介入。

* 弹性扩展：根据请求量做容量评估，考虑是否需要弹性扩容，如果需要及时扩容，新的机器启动软件程序和 ODP 程序提供服务，因为业务软件和 ODP 进程本身无状态，所以扩容一般都很快。

* 流量切换：对故障机器做好隔离，切走流量，转发到其他健康节点服务，保证请求正常执行。

通过上述方法，ODP 服务就可以及时恢复。上面步骤时间越短，可用性越高。

和应用端部署不同，独立部署模式下，ODP 部署在独立的机器上，同时也引入了负载均衡模块，放在 ODP 前面。这种部署架构下，ODP 的高可用和软件的高可用做了解耦，有多个 ODP 提供服务，也就是前面介绍到的冗余。LB 会对 ODP 做健康检查，及时发现 ODP 的故障，并将故障的 ODP 机器拉黑，不再转发 SQL 流量到故障机器。故障后 ODP 机器减少，会导致其他 ODP 机器的负载增加，如果发现其它机器负载过高，可以通过添加新的 ODP 机器缓解压力。

对比独立部署和应用端部署就会发现，独立部署出现高可用问题的概率更大，其主要原因是链路变长了。比如，业务软件和 ODP 出现网络故障导致服务不可用，在应用端部署的方式下，因为软件和 ODP 走本地通信，这种情况几乎不可能出现；而在独立部署方式下，这种问题出现的概率就会大很多。

## ODP 进程异常

除了机器故障，ODP 进程异常对高可用的影响也很大。产生异常的原因有很多，如程序 bug 导致进程 core、内存使用太多导致 OOM（Out Of Memory）、运维操作误杀进程等。虽然原因很多，但最终的表现形式就是服务端口无法提供服务。

对于这种情况，可以通过 obproxyd.sh 脚本解决，主要原理是通过 nc 命令访问 ODP 的监听端口，如果 TCP 建连成功就说明 ODP 进程存在；如果进程不存在，obproxyd.sh 脚本负责重新启动 ODP 进程。ODP 进程可以在 1 秒左右启动成功并提供服务。

当然，obproxyd.sh 能做的尽量恢复服务，举例说明，如果程序 bug 导致一启动就 core，此时无论如何重启都是无效的。对于这种情况，可以选择走机器异常的流程，由负载均衡组件进行处理。但对于概率很小的 bug，重启就可以及时恢复服务，对业务的影响会很小。

## OCP 模块异常

即使 ODP 一切正常，但如果依赖的第三方模块异常，ODP 也无法正常提供服务。本节主要介绍 OCP 模块异常。

OCP 为 ODP 提供了中心化的配置服务，OCP 保存了一些关键配置信息，如集群名和集群 rslist （OceanBase 总控服务 RS 的机器 IP 列表）的映射关系。当 ODP 从 OCP 拉取到 rslist 信息后，会保存本地 etc 目录下的 `obproxy_rslist_info.json` 文件中。

如果 OCP 不可用（通过 curl 命令访问 OCP 提供的 URL 可以确认），ODP 可以使用本地的 rslist 缓存文件提供服务。是否使用缓存文件通过配置项 `ignore_local_config` 控制，默认为 `true` 表示不使用本地缓存。

使用本地缓存可以解决 OCP 异常后的部分集群无法访问的问题，但也存在一定的缺点，如：

* 缓存中只保存了访问过的集群的 rslist 信息，如果集群未访问还是无法提供服务。

* 缓存信息具有时效性，如果机器的 rslist 变化后则无法感知。

因此，我们需要 OCP 自身是高可用设计的，并在出现问题后及时修复，这样才能保证服务不受影响。

总的来说，通过负载均衡组件和 obproxyd.sh 程序，可以及时处理进程异常和机器异常的情况。ODP 在实现时也对程序启动流程做了大量优化，可以在 1s 内完成初始化和配置加载，并对外提供服务。

ODP 尽量减少了对外部模块依赖，但无法做到不使用 OCP 模块，ODP 会通过本地缓存的方式降低依赖程度，尽量提高可用性。
