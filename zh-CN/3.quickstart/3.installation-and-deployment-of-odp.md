安装部署 ODP 
=============================

本文介绍如何通过编译源码和下载安装包安装 ODP。

前提条件 
-------------------------

在安装 ODP 之前，确保准备正确的安装环境。详细信息参考 [准备资源](/en-US/4.resource-preparation.md)。


下载 ODP 
---------------------------

您可以选择通过编译源码或下载安装包的方式获取 ODP。

* **编译源码** 

  使用源码安装 ODP 可以体验最新特性。详细信息，参考 [编译 ODP](/en-US/3.quickstart/4.compile-odp.md)。
  




<!-- -->

* **下载安装包** 

  使用以下命令下载 ODP 软件包：

  ```bash
  wget https://mirrors.aliyun.com/oceanbase/community/stable/el/7/x86_64/obproxy-3.1.0-.el7.x86_64.rpm
  ```

  

  运行以下命令安装 ODP 软件包：

  ```bash
  sudo rpm -ivh --prefix=<installation_path> <package_name>
  ```

  




部署 ODP 
---------------------------

ODP 支持在业务机器上的客户端部署和在公有云上的集中式部署。不同部署方式的 `connection id` 的生成机制不同。

**客户端部署** 

ODP 默认使用客户端部署。客户端部署不需要额外配置。运行以下命令检查当前 ODP 的部署方式：

```sql
obclient> SHOW proxyconfig LIKE "%proxy_id%";
+----------+-------+-----------------------------------------------------------------------------------+-------------+---------------+
| name     | value | info                                                                              | need_reboot | visible_level |
+----------+-------+-----------------------------------------------------------------------------------+-------------+---------------+
| proxy_id | 0     | used to identify each obproxy, it can not be zero if proxy_service_mode is server | true        | SYS           |
+----------+-------+-----------------------------------------------------------------------------------+-------------+---------------+
1 row in set (0.00 sec)


obclient> SHOW proxyconfig LIKE "%proxy_service_mode%";
+--------------------+--------+------------------------------------------------------------+-------------+---------------+
| name               | value  | info                                                       | need_reboot | visible_level |
+--------------------+--------+------------------------------------------------------------+-------------+---------------+
| proxy_service_mode | client | proxy deploy and service mode: 1.client(default); 2.server | true        | SYS           |
+--------------------+--------+------------------------------------------------------------+-------------+---------------+
1 row in set (0.00 sec)


obclient> SELECT * FROM ob_all_proxy\G
*************************** 1. row ***************************
                 proxy_ip: 10.125.224.18
               proxy_port: 13205
              regist_time: 2016-06-29 08:29:38
                 proxy_id: 0
                 app_name: ob1.jianhua.sjh
           binary_version: ObProxy-OceanBase 1.1.0-?
           config_version: 100
              system_info: (Linux)-(OceanBase224018.sqa.bjb)-(2.6.32-220.23.2.ali878.el6.x86_64)-(#1 SMP Mon Jan 28 17:12:52 CST 2013)-(x86_64)
              current_pid: 3178335
              update_time: 2016-06-29 09:54:01.564795
          hot_upgrade_cmd:
parent_hot_upgrade_status:
   sub_hot_upgrade_status:
       new_binary_version:
        new_binary_5u_md5:
        new_binary_6u_md5:
        new_binary_7u_md5:
            reload_config:
                     info: (hot_upgrade_cmd: hot_upgrade, rollback, commit, auto_upgrade or exit), (reload_config: reloading), (new_binary_version: new binary name for hot upgrade), (new_binary_[5u|6u|7u]_md5: md5sum of new binary)
1 row in set (0.01 sec)
```



**集中式部署** 

ODP 集中式部署有以下限制：

* ODP 集中式部署的个数必须可控。将每台 ODP 的 `proxy_service_mode` 变量设置为 `server`。为每台 ODP 设置唯一 `proxy_id`。 `proxy_id` 的取值范围是 `[1, 256]`。

  

* 您在一个集群中最多只能部署 255 台 ODP。因为 `proxy_id` 的取值范围是 `[1, 256]`。如果您使用了重复的 `proxy_id`，客户端连接将断开，此时系统返回 `Session already exist` 错误信息。

  






集中式部署 ODP 时，您可以通过以下方式为每台 ODP 配置 `proxy_service_mode` 和 `proxy_id`：

* 通过命令行配置。

  ```bash
   ./bin/obproxy -o proxy_service_mode=server,proxy_id=128
  ```

  

* 通过内部命令配置。

  当您使用内部命令配置时，您必须重启服务才能使修改生效。您必须先更新 `proxy_id` 才能更新 `proxy_service_mode`。

  ```bash
  obclient> --内部命令修改, 重启才能生效, 只有先更新proxy_id后才能更新proxy_service_mode成功:
  obclient> ALTER proxyconfig SET proxy_id=128;
  Query OK, 0 rows affected (0.01 sec)
  
  obclient> ALTER proxyconfig SET proxy_service_mode='server';
  Query OK, 0 rows affected (0.00 sec)
  
  obclient> SHOW proxyconfig LIKE "%proxy_id%";
  +----------+-------+-----------------------------------------------------------------------------------+-------------+---------------+
  | name     | value | info                                                                              | need_reboot | visible_level |
  +----------+-------+-----------------------------------------------------------------------------------+-------------+---------------+
  | proxy_id | 128   | used to identify each obproxy, it can not be zero if proxy_service_mode is server | true        | SYS           |
  +----------+-------+-----------------------------------------------------------------------------------+-------------+---------------+
  1 row in set (0.00 sec)
  
  obclient> SHOW proxyconfig LIKE "%proxy_service_mode%";
  +--------------------+--------+------------------------------------------------------------+-------------+---------------+
  | name               | value  | info                                                       | need_reboot | visible_level |
  +--------------------+--------+------------------------------------------------------------+-------------+---------------+
  | proxy_service_mode | server | proxy deploy and service mode: 1.client(default); 2.server | true        | SYS           |
  +--------------------+--------+------------------------------------------------------------+-------------+---------------+
  1 row in set (0.00 sec)
  ```

  




通过查看 `ob_all_proxy` 表中的 `proxy_id` 字段获取当前运行 ODP 的 `proxy_id`。

```bash
obclient> SELECT * FROM ob_all_proxy\G
*************************** 1. row ***************************
                 proxy_ip: 10.125.224.18
               proxy_port: 13205
              regist_time: 2016-06-29 08:29:38
                 proxy_id: 128
                 app_name: ob1.jianhua.sjh
           binary_version: ObProxy-OceanBase 1.1.0-?
           config_version: 100
              system_info: (Linux)-(OceanBase224018.sqa.bjb)-(2.6.32-220.23.2.ali878.el6.x86_64)-(#1 SMP Mon Jan 28 17:12:52 CST 2013)-(x86_64)
              current_pid: 3177384
              update_time: 2016-06-29 09:45:17.980320
          hot_upgrade_cmd:
parent_hot_upgrade_status:
   sub_hot_upgrade_status:
       new_binary_version:
        new_binary_5u_md5:
        new_binary_6u_md5:
        new_binary_7u_md5:
            reload_config:
                     info: (hot_upgrade_cmd: hot_upgrade, rollback, commit, auto_upgrade or exit), (reload_config: reloading), (new_binary_version: new binary name for hot upgrade), (new_binary_[5u|6u|7u]_md5: md5sum of new binary)
1 row in set (0.01 sec)

obclient> SHOW proxyconfig LIKE "%proxy_id%";
+----------+-------+-----------------------------------------------------------------------------------+-------------+---------------+
| name     | value | info                                                                              | need_reboot | visible_level |
+----------+-------+-----------------------------------------------------------------------------------+-------------+---------------+
| proxy_id | 128   | used to identify each obproxy, it can not be zero if proxy_service_mode is server | true        | SYS           |
+----------+-------+-----------------------------------------------------------------------------------+-------------+---------------+
1 row in set (0.00 sec)
```


