# 安装 ODP

您可通过 OBD、OCP 或者直接使用 RPM 安装部署 OBProxy，其中通过 OBD 安装是最为简单的方式，其安装步骤如下：

1. 检查安装环境

2. 选择合适版本

3. 通过 OBD 安装

4. 安装后检查

> **说明**
>
> * 通过 OCP 安装部署 OBProxy 请参考 [创建 OBProxy 集群](https://www.oceanbase.com/docs/enterprise-oceanbase-database-cn-10000000000355781)。
>
> * 使用 RPM 安装部署 OBProxy 请参考 [通过命令行部署 OBProxy](https://www.oceanbase.com/docs/enterprise-oceanbase-database-cn-10000000000355518)。

## 环境准备

* 平台：x86_64、arm

* OS: Linux Redhat 5u|6u|7u x86-64 及以上

* CPU: OBProxy 启动成功后，CPU 占用 0.7 C 左右

* 内存：OBProxy 启动成功后，内存占用百余兆

* 磁盘空间：对磁盘大小没有特别需求，根据数据大小决定，推荐 10G 及以上

* OceanBase 集群：详细信息请参考 [部署 OceanBase 集群](https://www.oceanbase.com/docs/enterprise-oceanbase-database-cn-10000000000355502)

## 选择合适版本

如果只是学习使用，一般安装最新的版本即可。如果是生产环境，建议关注每个版本的功能迭代和 bugfix 情况。阅读 Release Notes 可以帮助避坑和掌握每个版本的功能支持情况，做到心中有数。

OBProxy 的代码已经开源，在 OceanBase 开源项目中找到 OBProxy 项目，点击 [Releases](https://github.com/oceanbase/obproxy/releases) 可以查看每个版本的详细信息。OBProxy 每个版本都经过了功能测试、压力测试和性能测试，可以放心使用。

## 操作步骤

### 步骤 1：下载安装 OBD

安装部署 OBProxy 最快的方式是使用部署工具 OceanBase Deployer（简称 OBD），因此推荐您使用此方式部署 OBProxy。按照以下步骤下载并安装 OBD。 如您的机器可以访问公网，并能够添加三方 YUM 软件源，您可以运行以下命令，使用 OceanBase 的官方软件源安装 OBD：

```bash
sudo yum install -y yum-utils
sudo yum-config-manager --add-repo https://mirrors.aliyun.com/oceanbase/OceanBase.repo
sudo yum install -y ob-deploy
source /etc/profile.d/obd.sh
```

### 步骤 2：修改配置文件

OBD 安装成功后，可在 `/usr/obd/example/` 目录下查看 OBD 提供的配置文件，并根据需要选择合适的配置文件。

OBD 默认会安装最新版本，若想要安装指定 OBProxy 版本需要在配置文件中指定，配置文件中 OBProxy 的配置可参考下面内容，具体配置项的介绍请参考 [配置参数说明](2.parameter-description.md)。

```yaml
obproxy-ce:
  version: 3.2.3
  # Set dependent components for the component.
  # When the associated configurations are not done, OBD will automatically get the these configurations from the dependent components.
  depends:
    - oceanbase-ce
  servers:
    - 192.168.1.5
  global:
    listen_port: 2883 # External port. The default value is 2883.
    prometheus_listen_port: 2884 # The Prometheus port. The default value is 2884.
    home_path: /root/obproxy
    # oceanbase root server list
    # format: ip:mysql_port;ip:mysql_port. When a depends exists, OBD gets this value from the oceanbase-ce of the depends.
    rs_list: 192.168.1.2:2881;192.168.1.3:2881;192.168.1.4:2881
    enable_cluster_checkout: false
    # observer cluster name, consistent with oceanbase-ce's appname. When a depends exists, OBD gets this value from the oceanbase-ce of the depends.
    # cluster_name: obcluster
    skip_proxy_sys_private_check: true
    enable_strict_kernel_release: false
    # obproxy_sys_password: # obproxy sys user password, can be empty. When a depends exists, OBD gets this value from the oceanbase-ce of the depends.
    observer_sys_password: # proxyro user pasword, consistent with oceanbase-ce's proxyro_password, can be empty. When a depends exists, OBD gets this value
```

> **注意**
>
> * 您需在 rs_list 配置项中按要求填写该 OBProxy 可访问的 OceanBase 集群 IP 和 mysql_port 端口。
>
> * `observer_sys_password` 配置项需和部署 OceanBase 集群时配置的 `proxyro_password` 一致。

### 步骤 3：部署 OBProxy

1. 执行如下命令部署 OBProxy:

   ```bash
   obd cluster deploy <deploy_name> -c <deploy_config_path>
   ```

   其中，参数 `deploy_name` 为部署集群名称，可以理解为配置文件的别名，`deploy_config_path` 为配置文件名。

   在执行了 `obd cluster deploy` 命令之后，OBD 将检查您的目标机器是否有 OBProxy 安装包。如果没有安装包，OBD 将自动从 yum 源获取。

2. 执行如下命令启动 OBProxy

   ```bash
   obd cluster start <deploy_name> 
   ```

### 步骤 4：安装后检查

1. 通过如下命令查看部署情况：

   ```bash
   obd cluster display <deploy_name>

   # 示例
   [admin@test ~]$obd cluster display obtest
   Get local repositories and plugins ok
   Open ssh connection ok
   Cluster status check ok
   Connect to observer ok
   Wait for observer init ok
   +--------------------------------------------------+
   |                     observer                     |
   +----------------+---------+------+-------+--------+
   | ip             | version | port | zone  | status |
   +----------------+---------+------+-------+--------+
   | 172.xxx.xxx.109 | 3.1.4   | 2881 | zone1 | active |
   | 172.xxx.xxx.110 | 3.1.4   | 2881 | zone2 | active |
   | 172.xxx.xxx.111 | 3.1.4   | 2881 | zone3 | active |
   +----------------+---------+------+-------+--------+
   
   Connect to obproxy ok
   +--------------------------------------------------+
   |                     obproxy                      |
   +----------------+------+-----------------+--------+
   | ip             | port | prometheus_port | status |
   +----------------+------+-----------------+--------+
   | 172.xxx.xxx.109 | 2883 | 2884            | active |
   +----------------+------+-----------------+--------+
   ```

   通过该命令可以看到 OBProxy 信息，其中 port 列为 2883 表示提供 SQL 服务的端口是 2883，也就是 JDBC URL 中需要填写的 PORT。

2. 通过 `obd cluster display` 命令做过状态检查后，可以使用终端登录到 OBProxy 进程所在机器，执行 `ps -ef | grep obproxy` 命令查看进程信息。

   ```bash
   [admin@test ~]# ps -ef | grep obproxy | grep -v grep
   admin     6868     1  0 May20 ?        00:02:09 bash /home/admin/obproxy/obproxyd.sh /home/admin/obproxy 172.xxx.xxx.109 2883 daemon
   admin     6901     1  0 May20 ?        00:44:11 /home/admin/obproxy/bin/obproxy --listen_port 2883
   ```
<!-- 命令没有看懂，为什么还会有  | grep -v grep -->
   从上述示例中可以看到两个进程：obproxyd.sh 进程和 obproxy 进程。其中，obproxy 就是 OBProxy 的进程名，obproxyd.sh 是 OBProxy 的守护脚本，负责启动 obproxy，对 obproxy 做健康检查，如果 obproxy 进程不存在，obproxyd.sh 会主动拉起进程。
