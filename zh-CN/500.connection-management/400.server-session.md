# 服务端连接

本文介绍服务端连接（Server Session，即 ODP 和 OBServer 节点间的连接）的一些常用操作。

## 查看服务端连接

目前暂不支持直接通过 ODP 查看服务端连接。可以使用 root 用户登录 OceanBase 数据库的 sys 租户查看集群内的所有 Server，之后直连对应的 OBServer 节点查看连接。

详细的操作和输出介绍可参见《OceanBase 数据库》文档 [查看租户会话](https://www.oceanbase.com/docs/common-oceanbase-database-cn-1000000000218158)，此处仅简单介绍一种查看方法。

1. 使用 root 用户登录 OceanBase 数据库的 sys 租户查看集群内的所有 Server。

   ```sql
   obclient> select * from oceanbase.__all_server;
   +----------------------------+----------------------------+------------+----------+----+------+------------+-----------------+--------+-----------------------+--------------------------------------------------------------------------+-----------+--------------------+--------------+----------------+
   | gmt_create                 | gmt_modified               | svr_ip     | svr_port | id | zone | inner_port | with_rootserver | status | block_migrate_in_time | build_version                                                            | stop_time | start_service_time | first_sessid | with_partition |
   +----------------------------+----------------------------+------------+----------+----+------+------------+-----------------+--------+-----------------------+--------------------------------------------------------------------------+-----------+--------------------+--------------+----------------+
   | 2023-02-28 15:45:53.230044 | 2023-02-28 15:46:25.577180 | 10.10.10.1 |     2882 |  3 | z3   |       2881 |               1 | ACTIVE |                     0 | 4.1.0.0_1-703037f0b023c8ffa880258463b25b1735cf27b3(Feb 28 2023 13:21:21) |         0 |   1677570376568330 |            0 |              1 |
   | 2023-02-28 15:45:53.197477 | 2023-02-28 15:46:25.534448 | 10.10.10.2 |     2882 |  2 | z2   |       2881 |               0 | ACTIVE |                     0 | 4.1.0.0_1-703037f0b023c8ffa880258463b25b1735cf27b3(Feb 28 2023 13:21:21) |         0 |   1677570376522994 |            0 |              1 |
   | 2023-02-28 15:45:53.113870 | 2023-02-28 15:46:25.098607 | 10.10.10.3 |     2882 |  1 | z1   |       2881 |               0 | ACTIVE |                     0 | 4.1.0.0_1-703037f0b023c8ffa880258463b25b1735cf27b3(Feb 28 2023 13:21:21) |         0 |   1677570378084150 |            0 |              1 |
   +----------------------------+----------------------------+------------+----------+----+------+------------+-----------------+--------+-----------------------+--------------------------------------------------------------------------+-----------+--------------------+--------------+----------------+
   3 rows in set
   ```

2. 选择想要查看的 OBServer 节点，直连该 OBServer 节点，以直连 10.10.10.1，SQL 端口为 2881 为例。

   ```shell
   [admin@test001 ~]$ obclient -h10.10.10.1 -P2881 -uroot@sys -p -Doceanbase -A
   ```

3. 执行 `show processlist;` 命令查看当前 OBServer 节点的所有连接。

   ```sql
   obclient> show processlist;
   ```

   输出如下。

   ```sql
   +------------+---------+------------------+-----------+---------+------+--------+------------------+
   | Id         | User    | Host             | db        | Command | Time | State  | Info             |
   +------------+---------+------------------+-----------+---------+------+--------+------------------+
   | 3221812197 | root    | 10.10.10.1:48563 | NULL      | Query   |    0 | ACTIVE | show processlist |
   | 3222117829 | proxyro | 10.10.10.1:37876 | oceanbase | Sleep   |    6 | SLEEP  | NULL             |
   | 3221709618 | root    | 10.10.10.1:51390 | NULL      | Sleep   |  831 | SLEEP  | NULL             |
   +------------+---------+------------------+-----------+---------+------+--------+------------------+
   3 rows in set
   ```

## 终止服务端连接

您可通过 ODP 终止指定的服务端连接，也可通过直连 OBServer 节点终止服务端连接。

### 通过 ODP 终止

sys 租户可以通过 `KILL PROXYSESSION {cs_id | connection_id} ss_id` 语句终止指定的服务端连接，参数说明如下：

* cs_id 为 ODP 内部标记的每个 Client 的 id 号，可通过执行 `SHOW PROXYSESSION` 语句查看，输出中的 `Id` 即为 `cs_id`。

* `connection_id` 为整个 OceanBase 数据库标记的每个 Client 的 ID 号。`connection_id` 可通过 `SELECT CONNECTION_ID();` 语句获取

* `ss_id` 为 ODP 内部标记每个 Server 端会话（ Server Session）的 ID 号，可通过执行 `SHOW PROXYSESSION ATTRIBUTE` 语句获取。

操作步骤如下。

1. 使用 root@sys 用户通过 ODP 连接登录 OceanBase 数据库

   ```shell
   obclient -h10.10.10.1 -uroot@sys#obdemo -P2883 -p -c -A
   ```

   此处仅为示例，您需根据实际情况进行修改，详细的连接操作指引可参见 [通过 OBClient 连接 OceanBase 租户（MySQL 模式）](https://www.oceanbase.com/docs/common-oceanbase-database-cn-1000000000508045)。

2. 查看客户端连接，获取 `cs_id`

   ```shell
   SHOW PROXYSESSION;
   ```

   输出如下，返回结果中的 `Id` 即为 `cs_id`。

   ```shell
   +----------------------+-------+----------+--------+------+----------------------+------+-------------+-------------------+-------------------+-------+-------+-----------+
   | proxy_sessid         | Id    | Cluster  | Tenant | User | Host                 | db   | trans_count | svr_session_count | state             | tid   | pid   | using_ssl |
   +----------------------+-------+----------+--------+------+----------------------+------+-------------+-------------------+-------------------+-------+-------+-----------+
   | 12402504630519660556 | 64940 | test420  | sys    | root | 100.xx.xx.xx:63882   | NULL |           0 |                 1 | MCS_ACTIVE_READER | 76286 | 76286 |         0 |
   +----------------------+-------+----------+--------+------+----------------------+------+------------- +-------------------+-------------------+-------+-------+-----------+
   1 row in set

   ```

3. 根据获取的 `cs_id` 获取 `ss_id`

   ```shell
   SHOW PROXYSESSION ATTRIBUTE 64940;
   ```

   输出如下。

   ```shell
   +----------------------------------+----------------------+----------------+
   | attribute_name                   | value                | info           |
   +----------------------------------+----------------------+----------------+
   | proxy_sessid                     | -6044239443189891060 | cs common      |
   | cs_id                            | 64940                | cs common      |
   | cluster                          | test3233             | cs common      |
   | tenant                           | sys                  | cs common      |
   | user                             | root                 | cs common      |
   | host_ip                          | 100.xx.xx.xx         | cs common      |
   | host_port                        | 63882                | cs common      |
   | db                               | NULL                 | cs common      |
   | total_trans_cnt                  | 0                    | cs common      |
   | svr_session_cnt                  | 1                    | cs common      |
   | active                           | true                 | cs common      |
   | read_state                       | MCS_ACTIVE_READER    | cs common      |
   | tid                              | 76286                | cs common      |
   | pid                              | 76286                | cs common      |
   | idc_name                         |                      | cs common      |
   | modified_time                    | 0                    | cs stat        |
   | reported_time                    | 0                    | cs stat        |
   | hot_sys_var_version              | 0                    | cs var version |
   | sys_var_version                  | 2                    | cs var version |
   | user_var_version                 | 0                    | cs var version |
   | last_insert_id_version           | 0                    | cs var version |
   | db_name_version                  | 0                    | cs var version |
   | server_ip                        | xx.xx.xx.xx          | last used ss   |
   | server_port                      | 2881                 | last used ss   |
   | server_sessid                    | 3221579563           | last used ss   |
   | ss_id                            | 16                   | last used ss   |
   | state                            | MSS_KA_CLIENT_SLAVE  | last used ss   |
   | transact_count                   | 2                    | last used ss   |
   | server_trans_stat                | 0                    | last used ss   |
   | hot_sys_var_version              | 0                    | last used ss   |
   | sys_var_version                  | 2                    | last used ss   |
   | user_var_version                 | 0                    | last used ss   |
   | last_insert_id_version           | 0                    | last used ss   |
   | db_name_version                  | 0                    | last used ss   |
   | is_checksum_supported            | 1                    | last used ss   |
   | is_safe_read_weak_supported      | 0                    | last used ss   |
   | is_checksum_switch_supported     | 1                    | last used ss   |
   | checksum_switch                  | 1                    | last used ss   |
   | enable_extra_ok_packet_for_stats | 1                    | last used ss   |
   +----------------------------------+----------------------+----------------+
   39 rows in set
   ```

4. 终止客户端连接上的服务端连接

   ```shell
   KILL PROXYSESSION 64940 16;
   ```

### 直连 OBServer 节点终止

1. 使用 root 用户登录 OceanBase 数据库的 sys 租户查看集群内的所有 Server。

   ```sql
   obclient> select * from oceanbase.__all_server;
   +----------------------------+----------------------------+------------+----------+----+------+------------+-----------------+--------+-----------------------+--------------------------------------------------------------------------+-----------+--------------------+--------------+----------------+
   | gmt_create                 | gmt_modified               | svr_ip     | svr_port | id | zone | inner_port | with_rootserver | status | block_migrate_in_time | build_version                                                            | stop_time | start_service_time | first_sessid | with_partition |
   +----------------------------+----------------------------+------------+----------+----+------+------------+-----------------+--------+-----------------------+--------------------------------------------------------------------------+-----------+--------------------+--------------+----------------+
   | 2023-02-28 15:45:53.230044 | 2023-02-28 15:46:25.577180 | 10.10.10.1 |     2882 |  3 | z3   |       2881 |               1 | ACTIVE |                     0 | 4.1.0.0_1-703037f0b023c8ffa880258463b25b1735cf27b3(Feb 28 2023 13:21:21) |         0 |   1677570376568330 |            0 |              1 |
   | 2023-02-28 15:45:53.197477 | 2023-02-28 15:46:25.534448 | 10.10.10.2 |     2882 |  2 | z2   |       2881 |               0 | ACTIVE |                     0 | 4.1.0.0_1-703037f0b023c8ffa880258463b25b1735cf27b3(Feb 28 2023 13:21:21) |         0 |   1677570376522994 |            0 |              1 |
   | 2023-02-28 15:45:53.113870 | 2023-02-28 15:46:25.098607 | 10.10.10.3 |     2882 |  1 | z1   |       2881 |               0 | ACTIVE |                     0 | 4.1.0.0_1-703037f0b023c8ffa880258463b25b1735cf27b3(Feb 28 2023 13:21:21) |         0 |   1677570378084150 |            0 |              1 |
   +----------------------------+----------------------------+------------+----------+----+------+------------+-----------------+--------+-----------------------+--------------------------------------------------------------------------+-----------+--------------------+--------------+----------------+
   3 rows in set
   ```

2. 直连 OBServer 节点，以直连 10.10.10.1，SQL 端口为 2881 为例。

   ```shell
   [admin@test001 ~]$ obclient -h10.10.10.1 -P2881 -uroot@sys -p -Doceanbase -A
   ```

3. 执行 `show processlist;` 命令查看当前 OBServer 节点的所有连接。

   ```sql
   obclient> show processlist;
   ```

   输出如下。

   ```sql
   +------------+---------+------------------+-----------+---------+------+--------+------------------+
   | Id         | User    | Host             | db        | Command | Time | State  | Info             |
   +------------+---------+------------------+-----------+---------+------+--------+------------------+
   | 3221812197 | root    | 10.10.10.1:48563 | NULL      | Query   |    0 | ACTIVE | show processlist |
   | 3222117829 | proxyro | 10.10.10.1:37876 | oceanbase | Sleep   |    6 | SLEEP  | NULL             |
   | 3221709618 | root    | 10.10.10.1:51390 | NULL      | Sleep   |  831 | SLEEP  | NULL             |
   +------------+---------+------------------+-----------+---------+------+--------+------------------+
   3 rows in set
   ```

4. 以终止当前连接（`Id` 为 3221812197）为例，使用 `kill <id>` 命令。

   ```sql
   obclient> kill 3221812197;
   ERROR 2013 (HY000): Lost connection to MySQL server during query
   ```
