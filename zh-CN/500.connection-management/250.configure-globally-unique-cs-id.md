# 配置全局唯一的 Client Session ID

本文介绍配置全局唯一的 Client Session ID 功能出现的背景，以及功能如何使用。

## 背景

Client Session ID 是唯一标识当前的会话的 ID（下文简称为 cs_id），当前 ODP 和 OceanBase 数据库各自有一套 cs_id 生成机制，因此 ODP 生成的 cs_id 和 OBServer 节点不一致。当通过 ODP 连接 OBServer 节点时，ODP 会在 Handshake 阶段就将自身生成的 cs_id 回传给客户端，这就导致各个组件看到的 cs_id 不一致，因此需要统一各个组件使用的 cs_id。

## 前提条件

使用该功能前，需要确认以下信息：

* 您当前环境中待部署或已部署的 ODP 为 V4.2.3 或之后版本。

* 您当前环境中的 OceanBase 数据库为 V4.2.2 或之后版本。
  <!-- 等内核 422 发版后需要验证支持的版本情况 -->

## 操作步骤

目前有 **ODP 启动时配置** 和 **ODP 运行中修改配置** 分为两种配置方法，推荐在 ODP 启动时进行配置，在 ODP 运行中修改配置容易导致 cs_id 冲突。

### （推荐）方法一：ODP 启动时进行配置

您可在启动 ODP 时添加如下参数进行配置，示例如下：

```shell
-o "proxy_id=1,client_session_id_version=2"
```

此处仅为示例，您可将 `proxy_id` 配置为 0~8191 范围中除 2 以外的任意值，不与其他 ODP 重复即可。`proxy_id` 和 `client_session_id_version` 配置项的详细介绍可参见 [proxy_id](../400.configuration-management/200.dynamically-effective/1795.proxy-id.md) 和 [client_session_id_version]()。

### 方法二：ODP 运行中修改配置

不推荐使用该方法进行配置，在 ODP 运行时修改 `client_session_id_version` 和 `proxy_id` 配置项，容易导致 cs_id 冲突。

1. 使用 root@sys 用户通过 ODP 登录 OceanBase 数据库，或使用 root@proxysys 用户登录 ODP

   使用 root@sys 用户登录 OceanBase 数据库示例如下，详细参数介绍可参见《OceanBase 数据库》文档 [通过 OBClient 连接 OceanBase 租户](https://www.oceanbase.com/docs/common-oceanbase-database-cn-1000000000218474)。

   ```shell
   [admin@obtest ~]$ obclient -uroot@sys#obcluster -h10.10.10.1 -P2883 -p
   ```

   <main id="notice" type='notice'>
     <h4>注意</h4>
     <p>若要在 OceanBase 数据库中使用 ODP 命令，连接 OceanBase 数据库的连接 IP（<code>-h</code>）和连接端口（<code>-P</code>）需为 ODP 的地址和监听端口（<code>listen_port</code>）</p>
   </main>

   使用 root@proxysys 用户登录 ODP 示例如下，此处的连接 IP（`-h`）为 ODP 的地址，连接端口（`-P`）为 ODP 的监听端口（`listen_port`）。

   ```shell
   [admin@obtest ~]$ obclient -uroot@proxysys -h10.10.10.1 -P2883 -p
   ```

2. 执行如下命令配置 `client_session_id_version` 为 `2`

   ```shell
   [admin@obtest ~]$ alter proxyconfig set client_session_id_version=2;
   ```

   `client_session_id_version` 配置项表示 cs_id 使用的格式的版本，必须设置版本为 `2` 以使用新的计算逻辑。

3. （可选）执行如下命令配置 `proxy_id` 为 `1`

   <main id="notice" type='explain'>
     <h4>说明</h4>
     <p>不同的 ODP 需要设置不同 <code>proxy_id</code> 是为了保证 cs_id 生成的唯一性，单个 ODP 的集群无需考虑该配置项。</p>
   </main>

   ```shell
   [admin@obtest ~]$ alter proxyconfig set proxy_id=1;
   ```

   此处仅为示例，您可将 `proxy_id` 配置为 0~8191 范围中除 2 以外的任意值，不与其他 ODP 重复即可。
