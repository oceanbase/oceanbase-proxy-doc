# OceanBase 数据库代理企业版 V4.2.3

## V4.2.3

### 版本信息

* 发布时间：2023 年 12 月 26 日

* 版本号：V4.2.3

* RPM 版本号：obproxy-4.2.3.0-20231226165754

### 版本定位

继 ODP V4.2.2 支持了路由诊断、连接诊断等易用性能力后，ODP V4.2.3 新增支持如下功能：

* 支持登录审计日志、日志易用性、协议诊断、内存诊断易用性等功能，全面提升易用性能力；支持宽整型路由，支持更多分区函数和表达式路由，丰富路由能力。

* 支持全局唯一 Client Session ID，支持 OBProxy 到 OBServer 节点的协议压缩功能，增强链路能力。

* 支持 MYSQL_SET_OPTION(27) 命令、load data local file 等 MySQL 兼容功能。

### 关键特性说明

<!-- ### 全局唯一 Client Session ID  这个是适配 OB V4.3.0 的功能，是否等 OB V4.3.0 发布后再透出 -->

#### ODP 到 OBServer 节点的链路压缩

OceanBase 集群支持两点三中心等异地部署方式，当 OceanBase 数据库的不同副本跨城部署时，跨城读/写数据，可能会遇到带宽限制。ODP V4.2.3 支持 ODP 和 OBServer 节点间的数据压缩后，在插入数据随机性较大的情况，数据压缩率稳定在 55% 左右，可有效地降低带宽压力。

#### 日志易用性

为协助用户快速排查问题，ODP 支持了 obproxy_digest.log、obproxy_error.log、obproxy.log 等多种日志。日志多而全的同时，也带来一些问题，比如日志可读性差、日志量大和日志打印引起性能损耗，降低日志易用性。

本次易用性改进，一方面通过增加限流、优化打印的方式解决了日志打印过快的问题，另一方面也对不合理的日志内容进行治理，设置了更清晰的日志级别，较大程度地提升日志可读性，同时解决了日志量大的问题。

#### 内存易用性

ODP 目前记录的内存信息有限，发生内存泄漏后难以快速定位泄漏位置，使得排查困难，同时内存超限以后的建连行为和日志需要优化。

本次易用性改进，增加了内存泄露诊断功能、WARN 提醒日志，在内存超限后会建连失败，分配 PS 也会失败，而不是强制退出，降低了对已有的业务的影响。

#### 路由完善

OceanBase 数据库列存版本支持宽整型，ODP 配合支持以宽整型为分区键的分区表查询进行准确路由。

支持更多的分区表达式，包括算术表达式、字符表达式和时间表达式等进行准确路由。

### 兼容性变更

#### 产品行为变更

日志级别变更，默认级别为 WDIAG，详细介绍可参见 [日志]()。

内存超限 90% 后，行为改变：

* 已有连接：PS 内存分配失败（断开连接）、其他 SQL 执行正常

* 新建连接：普通租户新建连接失败、sys 租户和 proxysys 租户新建连接成功且配置更改以及 SQL 执行正常

#### 配置项变更

| 配置项   | 变更类型  | 变更说明   |
|----------|----------|-----------|
<!-- | proxy_primary_zone_name | 变更 | 类型：varchar </br>默认值：空 </br>生效级别：全局/集群/租户/vip </br>含义：指定 OceanBase 集群的副本进行路由  |  这个好像是之前和致新对，不需要修改的配置项 -->
| mem_leak_check_mod_name | 新增  |  |
| mem_leak_check_class_nam | 新增  |  |
| protocol_diagnosis_level | 新增  |  |
| compression_algorithm | 新增  |  |
| syslog_io_bandwidth_limit | 新增  |  |
| enable_syslog_wf | 新增  |  |

### 支持的 OceanBase 数据库版本

支持 OceanBase 数据库 4.x 版本和 3.x 以及之前版本。
<!-- 这句的意思是支持 OB 所有版本么 -->
根据使用的 OceanBase 数据库版本不同，对应推荐如下：

* 当 OceanBase 数据库为 3.x 版本及之前版本时，建议使用 ODP V3.2.11。

* 当 OceanBase 数据库为 4.x 版本时，有如下两种情况。
  
  * 若使用过程中依赖新功能，推荐使用 ODP V4.2.3。
  
  * 若使用过程中不依赖新功能，推荐使用 ODP V4.2.1（LTS 版本）。

### 缺陷修复

* 修复 .net 驱动连接时，开启 SSL 导致建连失败的问题

* 修复 .net 驱动连接时，解析 conn attr 报错断连的问题

* 修复 ODP 连接集群，使用游标 fetchsize 性能差的问题

* 修复 MySQL 8.0 客户端无法连接带密码的 OceanBase 集群问题
