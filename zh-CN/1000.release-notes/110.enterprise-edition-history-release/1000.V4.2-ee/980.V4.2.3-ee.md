# OceanBase 数据库代理企业版 V4.2.3

## V4.2.3 BP1

### 版本信息

* 发布时间：2024 年 2 月 2 日

* 版本号：V4.2.3 BP1

* RPM 版本号：obproxy-4.2.3.0-20240131105459

### 版本定位

修复严重功能缺陷，代替 ODP V4.2.3 版本。

### 缺陷修复

* 修复 GB18030 字符集下，执行大小写转换操作遇到的死循环问题。

* 修复 Load data local file 执行卡住的问题。

* 修复 SQL 中含有 'status'，导致后面语句未被正确解析的问题。

## V4.2.3

<main id="notice" type='notice'>
  <h4>注意</h4>
  <p>ODP V4.2.3 版本存在高风险功能缺陷，不推荐使用，建议使用 ODP V4.2.3 BP1 版本。</p>
</main>

### 版本信息

* 发布时间：2023 年 12 月 26 日

* 版本号：V4.2.3

* RPM 版本号：obproxy-4.2.3.0-20231226165754

### 版本定位

继 ODP V4.2.2 支持了路由诊断、连接诊断等易用性能力后，ODP V4.2.3 新增支持如下功能：

* 支持登录审计日志、日志易用性、协议诊断、内存诊断易用性等功能，全面提升易用性能力；支持宽整型路由，支持更多分区函数和表达式路由，丰富路由能力。

* 支持全局唯一 Client Session ID，支持 OBProxy 到 OBServer 节点的协议压缩功能，增强链路能力。

* 支持 MYSQL_SET_OPTION(27) 命令、load data local file 等 MySQL 兼容功能。

### 关键特性说明

#### 全局唯一 Client Session ID

Client Session ID 是唯一标识当前会话的ID，ODP 和 OceanBase 数据库各自有一套生成机制，ODP 生成的 Client Session ID 和 OBServer 节点不一致，当通过 Client 连接 ODP 的时候，ODP 会在 Handshake 阶段就将自身生成的 Client Session ID 回传给客户端，在分布式系统中，客户端连接负载均衡组件后，可能连接到不同的 ODP，不同 ODP 之间无法感知对方生成的 Client Session ID，所以需要实现全局唯一的 Client Session ID。使用全局唯一的 Client Session ID 之后，OceanBase 集群能够支持更完善的 `kill session`、`show processlist` 机制以及事务表锁等功能。

#### ODP 到 OBServer 节点的链路压缩

OceanBase 集群支持两地三中心等异地部署方式，当 OceanBase 数据库的不同副本跨城部署时，跨城读、写数据可能会遇到带宽限制。ODP V4.2.3 支持 ODP 和 OBServer 节点间的数据压缩后，在插入数据随机性较大的情况，数据压缩率稳定在 55% 左右，可有效地降低带宽压力。

#### 日志易用性

为协助用户快速排查问题，ODP 支持了 obproxy_digest.log、obproxy_error.log、obproxy.log 等多种日志。日志多而全的同时，也带来一些问题，比如日志可读性差、日志量大和日志打印引起性能损耗，降低日志易用性。

本次易用性改进，一方面通过增加限流、优化打印的方式解决了日志打印过快的问题，另一方面也对不合理的日志内容进行治理，设置了更清晰的日志级别，较大程度地提升日志可读性，同时解决了日志量大的问题。日志级别以及各个日志的详细介绍可参见 [日志](../../../650.log/100.overview-of-logs.md) 章节。

#### 内存易用性

ODP 目前记录的内存信息有限，发生内存泄漏后难以快速定位泄漏位置，使得排查困难，同时内存超限以后的建连行为和日志需要优化。

本次易用性改进，增加了内存泄露诊断功能、WARN 提醒日志，在内存超限后会建连失败，分配 PS 也会失败，而不是强制退出，降低了对已有的业务的影响。内存诊断的详细操作可参见 [内存诊断](../../../900.o-m-guide/500.memory-diagnosis.md)。

#### 路由完善

OceanBase 数据库列存版本支持宽整型，ODP 配合支持以宽整型为分区键的分区表查询进行准确路由。支持更多的分区表达式，包括算术表达式、字符表达式和时间表达式等进行准确路由。详细介绍可参见 [函数分区键路由](../../../600.data-routing/700.expression-routing/100.overview-of-expression-routing.md)。

### 兼容性变更

#### 产品行为变更

系统日志级别变更，默认级别为 WDIAG。

内存超限 90% 后，行为改变：

* 已有连接：PS 内存分配失败（断开连接）、其他 SQL 执行正常

* 新建连接：普通租户新建连接失败、sys 租户和 proxysys 租户新建连接成功且配置更改以及 SQL 执行正常

#### 配置项变更

| 配置项   | 变更类型  | 变更说明   |
|----------|----------|-----------|
| mem_leak_check_mod_name | 新增  | 用于设置 `show proxymemory;` 命令需要监控的对应 `mod_name`，，取值为 `ALL` 时代表全部监控（建议只在 DEBUG 时开启）。 |
| mem_leak_check_class_nam | 新增  | 用于设置 `show proxymemory objpool;` 命令需要监控的对应类名（`free_list_name`），取值为 `ALL` 时代表全部监控（建议只在 DEBUG 时开启）。 |
| protocol_diagnosis_level | 新增  | 用于控制是否开启协议诊断，以及是否将诊断信息输出到日志中。默认值为 0，表示关闭协议诊断。 |
| compression_algorithm | 新增  | 用于控制压缩协议和 OceanBase 2.0 协议的压缩级别，取值范围为 zlib:[0-9]，取值为 `zlib:0` 时表示禁用压缩协议和 OceanBase 2.0 协议中的压缩功能。 |
| syslog_io_bandwidth_limit | 新增  | 用于设置 ODP 日志每秒所能占用的磁盘 IO 带宽上限，超过带宽上限容量的 ODP 日志将被限流。触发限流时，obproxy.log 中会打印日志 `REACH SYSLOG RATE LIMIT`。默认值为 30MB，配置时需说明单位，默认单位为 MB。 |
| enable_syslog_wf | 新增  | 用于设置是否将 WARN 以上级别的 obproxy.log 日志打印到一个单独的日志文件（obproxy.log.wf）中。默认值为 `False`，表示不生成单独的日志文件。 |
| client_session_id_version | 新增  | 用于设置 Client Session ID 生成使用格式的版本，默认值为 1，需要设置版本为 2 以使用新的计算逻辑。  |
| enable_abort_conn_info   | 删除   | 该配置项自 4.2.0 版本开始引入，并于 4.2.3 版本删除。  |
| xflush_log_level        | 变更  |  | 该配置项自 4.2.3 版本起默认值由 `INFO`  更新为  `ERROR`。  |
| syslog_level         | 变更    | 该配置项自 4.2.3 版本起默认值由 `INFO`  更新为  `WDIAG`。  |
| connection_diagnosis_option | 变更   | 该配置项自 4.2.3 版本起，默认值由 `1` 更新为 `3`，并修改比特 1 位的含义为：用于指定是否在内部错误发生时尝试构建错误包。 |
| enable_sharding   | 变更    | 该配置项自 4.2.3 版本起，由修改动态生效变更为修改需重启生效。 |

### 支持的 OceanBase 数据库版本

支持 OceanBase 数据库 4.x 版本和 3.x 以及之前版本。根据使用的 OceanBase 数据库版本不同，对应推荐如下：

* 当 OceanBase 数据库为 3.x 版本及之前版本时，建议使用 ODP V3.2.11。

* 当 OceanBase 数据库为 4.x 版本时，有如下两种情况。
  
  * 若使用过程中依赖新功能，推荐使用 ODP V4.2.3。
  
  * 若使用过程中不依赖新功能，推荐使用 ODP V4.2.1（LTS 版本）。

### 缺陷修复

* 修复使用 .net 驱动连接时，开启 SSL 导致建连失败的问题。

* 修复使用 .net 驱动连接时，解析 conn attr 报错断连的问题。

* 修复 ODP 连接集群，使用游标 fetchsize 性能差的问题。

* 修复使用 MySQL 8.0 客户端无法连接带密码的 OceanBase 集群问题。
