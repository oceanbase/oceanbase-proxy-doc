# OceanBase 数据库代理企业版 V4.2.2

## V4.2.2

### 版本信息

* 发布时间：2023 年 10 月 30 日

* 版本号：V4.2.2

* RPM 版本号：obproxy-4.2.2.0-20231030193404

### 版本定位

ODP V4.2.2 支持 AWS 下的 PPV2 协议、Binlog 地址变更、SSL 控制 TLS 版本只使用 TLS1.2 或者 TLS1.3 功能，增强多云产品能力；完善路由诊断、连接诊断功能，加强易用性能力；解决特殊字符在 GBK 字符集下的乱码问题，完善只读场景下 Leader 变更反馈机制，提升产品稳定性。

### 关键特性说明

#### AWS 下的 PPV2 协议

通过 PPV2 协议，ODP 可以获取到 VPC（Virtual Private Cloud，虚拟私有云） ID、客户端 IP、IB IP 等信息，根据这些信息，在 AWS 中实现只读地址、一段式登录数据库的能力。
<!-- IB IP 是什么 -->
#### 路由诊断

基于 ODP V4.2.1 支持的路由诊断能力进一步完善，记录完整的路由信息，包括 parser 解析结果、parition 计算结果、使用的 location cache、使用的路由策略、每次重试原因、事务中的SQL、记录事务开启节点路由情况。支持 SQL hint `/*+ ODP explain_route*/` 输出完整信息，将慢 SQL 、断连接和路由不准、高可用探测失败的信息输出到 `obproxy_diagnosis.log` 日志文件中。详细使用说明参考 [路由诊断](../../../900.o-m-guide/400.routing-diagnosis/100.overview-of-routing-diagnosis.md) 章节。

#### 连接诊断

基于 ODP V4.2.1 支持的连接诊断能力进一步完善。在 `obproxy_diagnosis.log` 日志文件中记录断连接行为，关键字段说明断连接发起方（ODP 主动断开、客户端断开等），记录断连接的时间、用户名、租户名、集群名、执行 SQL、客户端 IP 和 Port、服务端 IP 和 Port、cs_id 、proxy_sess_id、server_sessid 和断开原因。 详细使用说明参考 [连接诊断]()。

#### 只读场景下 Leader 变更反馈机制

只读场景下，Leader 有可能会发生变化，ODP 不刷新location cache，会导致请求发到新的 Leader 节点，不符合预期。新设计一种 Leader 变更反馈机制：只读地址场景下，OBServer 节点通过 OK 包 KV 对的方式告诉 ODP 这台机器是否是主，分如下几种情况。

* 当前机器没有任何副本

* 涉及到的部分/所有副本分布在当前机器:

  * ALL FOLLOWER

  * ALL LEADER

  * PART LEADER/PART FOLLOWER

当前机器没有任何副本时，ODP 会主动触发 Location Cache 刷新；
ALL LEADER 且 ODP 自身认为选择的节点是 Follower 时，ODP 会主动触发 Location Cache 刷新，从而避免再次将只读请求发送到 Leader。

### 兼容性变更

#### 配置项变更

| 配置项   | 变更类型  | 变更说明   |
|----------|----------|-----------|
| connection_diagnosis_option | 新增 | 通过 bit 位指定当前连接诊断的能力，bit 1 用于指定是否开启连接诊断日志记录， bit 2 用于指定内部错误发生时是否保持连接不断开。 |
| enable_connection_diagnosis | 废弃 | 增加新配置 `connection_diagnosis_option` 代替。 |
| ssl_attributes | 变更 | 用于配置 SSL 连接，配置为 json 格式，第一个 key 是 using-ssl，表示建连强制走 SSL；第二个 key 是 tls_version，配置 SSL 连接指定的 TLS 版本号。 |

### 支持的 OceanBase 数据库版本

支持 OceanBase 数据库 4.x 和 3.x 以及更低版本。根据使用的 OceanBase 数据库版本不同，对应推荐如下：

* 当 OceanBase 数据库为 3.x 版本及更低版本时，建议使用 ODP V3.2.11。

* 当 OceanBase 数据库为 4.x 版本时，有如下两种情况。
  
  * 若使用过程中依赖新功能，推荐使用 ODP V4.2.2。
  
  * 若使用过程中不依赖新功能，推荐使用 ODP V4.2.1（LTS 版本）。

### 缺陷修复

* 修复连接诊断功能引入的内存泄露导致 ODP 内存爆满的问题。

* 修复 Binlog 请求场景下，单个请求的执行时间超过 ODP 缓存的集群过期时间时，导致 Binlog 请求断连接的问题。

* 修复开启高可用开关后，概率性连接 Binlog 服务失败的问题。

* 修复指定 IP 路由功能中，指定 `*`、`0` 等异常端口导致的断连接问题。
