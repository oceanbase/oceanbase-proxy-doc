# Strategy-based routing

This topic describes concepts related to strategy-based routing and provides two examples to describe how to configure strategy-based routing.

## Concepts

This section describes concepts related to strategy-based routing, such as logical data center (LDC), routing strategy, and routing type.

### LDC

LDC-based routing can resolve the issue of latency caused by remote routing when multiple IDCs are deployed across multiple regions in a distributed relational database.

As a typical high-availability distributed relational database system, OceanBase Database uses the Paxos protocol for log synchronization. OceanBase Database natively supports multi-region and multi-IDC deployment to ensure high disaster tolerance and reliability. However, every database deployed across multiple regions and IDCs has a latency issue caused by routing. OceanBase Database provides the LDC routing feature to address this issue. If the region and IDC attributes are specified for each zone in an OceanBase cluster and the IDC name attribute is specified for ODP, when a data request is sent to ODP, ODP will select an OBServer node in the following sequence: an OBServer node in the same IDC, an OBServer node in the same region, and a remote OBServer node.

<main id="notice" type='explain'>
    <h4>Note</h4>
    <p>ODP does not allow you to use LDC-based routing alone. You must use LDC-based routing in combination with the routing strategy. Routing to an OBServer node in the same IDC is just one dimension in strategy-based routing. </p>
</main>

### Routing strategy

ODP performs routing based on rules defined in the routing strategy in the following cases:

* Weak-consistency reads

* Strong-consistency reads based on the primary zone

* Partition calculation failure in the case of strong-consistency reads to partitioned tables

In strategy-based routing of ODP, the logical priorities of OBServer nodes are determined by the routing strategy. You can specify a routing strategy by using the ODP parameter `proxy_route_policy` or the user variable `@proxy_route_policy`. The following routing strategies are supported:

* FOLLOWER_FIRST: Requests are first routed to a follower, and are routed to the leader only when no follower is available.

* FOLLOWER_ONLY: Requests are routed only to a follower. If no follower is available, an error is returned.

* UNMERGE_FOLLOWER_FIRST: Requests are preferentially routed to a follower that is not in a major compaction.

<main id="notice" type='notice'>
  <h4>Notice</h4>
  <p>The routing strategies related to read-only zones have been deprecated. </p>
</main>

### Routing type

A routing strategy is a collection of logical priorities and consists of multiple routing types. A routing type consists of five dimension attributes of replicas.

* Paxos type: LEADER and FOLLOWER

* Partitioned table type: PARTITION and NONPARTITION

* Zone type: READWRITE and READONLY

* Major compaction status of SSTable: UNMERGE and MERGE

* Geographic location: LOCAL, REGION, and REMOTE

* Replication table replica: `DUP` and `-`

For example, priorities in the FOLLOWER_FIRST routing strategy are arranged in descending order as follows:

* FOLLOWER_PARTITION_UNMERGE_LOCAL: follower, partition replica, merged, same rack

* FOLLOWER_PARTITION_UNMERGE_REGIO: follower, partition replica, merged, same region

* FOLLOWER_PARTITION_MERGE_LOCAL: follower, partition replica, merging, same rack

* FOLLOWER_PARTITION_MERGE_REGION: follower, partition replica, merging, same region

* LEADER_PARTITION_UNMERGE_LOCAL: leader, partition replica, merged, same rack

* LEADER_PARTITION_UNMERGE_REGIO: leader, partition replica, merged, same region
   ...

## Procedure

The procedure for using strategy-based routing is as follows:

1. Configure an LDC for an OceanBase cluster.

2. Configure the instance-level parameter `proxy_idc_name` of ODP.

   <main id="notice" type='notice'>
     <h4>Notice</h4>
     <p>If <code>proxy_idc_name</code> is left empty, LDC-based routing will fail. </p>
   </main>

3. Configure the instance-level parameter `proxy_route_policy` of ODP for more fine-grained priority control. If you only need to control the routing to a zone or IDC, you can skip this configuration step. If this parameter is not configured, ODP will use the default routing strategy `MERGE_IDC_ORDER`.

4. Initiate a read request.

### Example 1: Route to the specified IDC

#### Step 1: Configure the IDCs of an OceanBase cluster

Log on to the OceanBase cluster as the root@sys user and execute the following statements to configure the LDC of the cluster. In this example, the cluster has three zones and each zone contains one OBServer node.

Configure the region of z1. The parameter `REGION` specifies the region where the zone resides and is usually set to a city name, which is case-sensitive.

```sql
obclient [oceanbase]> ALTER SYSTEM MODIFY ZONE "z1" SET REGION = "SHANGHAI";
```

Configure the IDC where z1 resides. The `IDC` parameter specifies the IDC where the zone resides and is usually set to an IDC name, which is in lowercase.

```sql
obclient [oceanbase]> ALTER SYSTEM MODIFY ZONE "z1" SET IDC = "zue";
```

<main id="notice" type='explain'>
   <h4>Note</h4>
   <p>An OceanBase cluster has several regions. A region has several zones. A zone has a zone type attribute and an IDC attribute. </p>
</main>

The following table lists the configurations of the cluster.

| IP address of OBServer node | Zone | IDC | REGION |
|------------------|--------|--------|-----------|
| 10.10.10.1 | z1 | zue | SHANGHAI |
| 10.10.10.2 | Zone z2 | xue | SHANGHAI |
| 10.10.10.3 | z3 | yue | HANGZHOU |

#### Step 2: Configure the ODP parameter

Configure the `proxy_idc_name` parameter to specify the location of ODP in the LDC. This example assumes that all weak-consistency read requests are routed to z1. Execute the following statement to set `proxy_idc_name` to `zue`:

```sql
obclient [oceanbase]> ALTER PROXYCONFIG SET PROXY_IDC_NAME ='zue';
```

#### Step 3: Initiate a read request

1. Create a table named t1 and initiate a weak-consistency read request.

   ```sql
   obclient [test]> SELECT /*+READ_CONSISTENCY(WEAK) */ * FROM test.t1;
   ```

2. Run the EXPLAIN ROUTE command to view the routing process in ODP.

   ```sql
   obclient [test]> EXPLAIN ROUTE SELECT /*+READ_CONSISTENCY(WEAK) */ * FROM test.t1\G
   ```

   In the following return result, the idc_type value is SAME_IDC, which indicates that the replica is in the same IDC as ODP, that is, z1.

   ```sql
   *************************** 1. row ***************************
   ...
   Route Plan
   -----------------
   > SQL_PARSE:{cmd:"COM_QUERY", table:"t1"}
   > ROUTE_INFO:{route_info_type:"USE_PARTITION_LOCATION_LOOKUP"}
     > TABLE_ENTRY_LOOKUP_DONE:{table:"t1", table_id:500006, table_type:"USER TABLE", entry_from_remote:false}
   > ROUTE_POLICY:{replica:"10.10.10.1:50109", idc_type:"SAME_IDC", zone_type:"ReadWrite", role:"LEADER", type:"FULL", is_partition_server:true, chosen_route_type:"ROUTE_TYPE_PARTITION_UNMERGE_LOCAL", route_policy:"MERGE_IDC_ORDER", trans_consistency:"WEAK", session_consistency:"STRONG", proxy_idc_name:"zue"}
   > CONGESTION_CONTROL:{svr_addr:"10.10.10.1:50109"}
   ```

<main id="notice" type='explain'>
   <h4>Note</h4>
   <p>You can configure the <code>proxy_idc_name</code> parameter to route weak-consistency read requests to another region. For example, you can set <code>proxy_idc_name</code> to <code>yue</code> to route weak-consistency read requests to HANGZHOU. </p>
</main>

### Example 2: Route to followers in the specified IDC

#### Step 1: Configure an OceanBase cluster

Log on to the OceanBase cluster as the root@sys user and execute the following statements to configure the LDC of the cluster. In this example, the cluster has three zones and each zone contains one OBServer node.

Configure the region of z1. The parameter `REGION` specifies the region where the zone resides and is usually set to a city name, which is case-sensitive.

```sql
obclient [oceanbase]> ALTER SYSTEM MODIFY ZONE "z1" SET REGION = "SHANGHAI";
```

Configure the IDC where z1 resides. The `IDC` parameter specifies the IDC where the zone resides and is usually set to an IDC name, which is in lowercase.

```sql
obclient [oceanbase]> ALTER SYSTEM MODIFY ZONE "z1" SET IDC = "zue";
```

<main id="notice" type='explain'>
   <h4>Note</h4>
   <p>An OceanBase cluster has several regions. A region has several zones. A zone has a zone type attribute and an IDC attribute. </p>
</main>

Create a table named t1 and execute the following statement to view the leader and followers of the table.

```sql
obclient [oceanbase]> select * from oceanbase.DBA_OB_TABLE_LOCATIONS where DATABASE_NAME='test' and TABLE_NAME like 't1'\G
```

The following table lists the configurations of the cluster.

| IP address of OBServer node | Leader/Follower | Zone | IDC | REGION |
|------------------|----------|--------|--------|-----------|
| 10.10.10.1 | Leader | z1 | zue | SHANGHAI |
| 10.10.10.2 | Follower | Zone z2 | xue | SHANGHAI |
| 10.10.10.3 | Follower | z3 | yue | HANGZHOU |

#### Step 2: Configure the ODP parameter

Configure the `proxy_idc_name` parameter to specify the location of ODP in the LDC. Configure the `proxy_route_policy` parameter to specify the routing strategy. This example assumes that all weak-consistency read requests are routed to a follower in the same IDC. Here are the sample statements:

```sql
obclient [oceanbase]> ALTER PROXYCONFIG SET PROXY_IDC_NAME ='zue';
obclient [oceanbase]> ALTER PROXYCONFIG SET proxy_route_policy = FOLLOWER_FIRST;
```

#### Step 3: Initiate a read request

Run the EXPLAIN ROUTE command to view the routing process in ODP.

```sql
obclient [oceanbase]> EXPLAIN ROUTE SELECT /*+READ_CONSISTENCY(WEAK) */ * FROM test.t1\G
```

In the following return result, the `idc_type` value is SAME_IDC, which indicates that the replica is in the same IDC as ODP, and the `role` value is FOLLOWER, which indicates that the request is routed to a follower.

```sql
...
Route Plan
-----------------
> SQL_PARSE:{cmd:"COM_QUERY", table:"t1"}
> ROUTE_INFO:{route_info_type:"USE_PARTITION_LOCATION_LOOKUP"}
  > TABLE_ENTRY_LOOKUP_DONE:{table:"t1", table_id:500006, table_type:"USER TABLE", entry_from_remote:false}
> ROUTE_POLICY:{replica:"10.10.10.2:50110", idc_type:"SAME_IDC", zone_type:"ReadWrite", role:"FOLLOWER", type:"FULL", is_partition_server:true, chosen_route_type:"ROUTE_TYPE_FOLLOWER_PARTITION_UNMERGE_LOCAL", route_policy:"FOLLOWER_FIRST", trans_consistency:"WEAK", session_consistency:"STRONG", proxy_idc_name:"zue"}
> CONGESTION_CONTROL:{svr_addr:"10.10.10.2:50110"}
```
