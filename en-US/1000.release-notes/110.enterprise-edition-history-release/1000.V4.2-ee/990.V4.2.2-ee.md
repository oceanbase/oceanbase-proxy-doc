# ODP Enterprise Edition V4.2.2

## V4.2.2

### Version information

* Release date: October 30, 2023

* Version: V4.2.2

* RPM version: obproxy-4.2.2.0-20231030193404

### Overview

OceanBase Database Proxy (ODP) V4.2.2 supports proxy protocol version 2 (PPv2) in Amazon Web Services (AWS), binlog service address change, use of only Transport Layer Security (TLS) 1.2 or TLS 1.3 in Secure Sockets Layer (SSL) to enhance the capabilities of OceanBase Cloud. ODP V4.2.2 also improves routing diagnostics, connection diagnostics, and ease-of-use (EOU). Besides, it addresses the issue of special characters being displayed as garbled characters when the GBK character set is used. It also optimizes the leader change feedback mechanism in read-only scenarios to improve system stability.

### Key features

#### PPv2 in AWS

ODP can obtain the virtual private cloud (VPC) ID, client IP address, and load balancer (LB) IP address by using the PPv2 protocol. Based on the obtained information, ODP can implement the capability to log on to OceanBase Database by using a read-only address or an address in the one-segment format in AWS.

#### Routing diagnostics

The routing diagnostics feature (supported since ODP V4.2.1) is improved in that complete routing information is recorded, including the parsing result provided by the parser, partition calculation result, location cache, routing strategy, reason for each retry, SQL statements in the transaction, and routing information about the node where the transaction is started. The SQL hint `/*+ ODP explain_route*/` can be used to output complete information, including slow SQL statements, disconnections, inaccurate routing, and high availability detection failures, to the `obproxy_diagnosis.log` file. For more information, see [Overview](../../../900.o-m-guide/400.routing-diagnosis/100.overview-of-routing-diagnosis.md).

#### Connection diagnostics

The connection diagnostics feature (supported since ODP V4.2.1) is improved. The `obproxy_diagnosis.log` file records disconnections and the key fields to indicate the disconnection initiator (ODP or client), disconnection time, username, tenant name, cluster name, executed SQL statements, client IP address and port, server IP address and port, connection session ID, proxy session ID, server session ID, and reason of disconnection.  For more information, see [Connection diagnostics](../../../500.connection-management/500.connection-diagnosis.md).

#### Leader change feedback mechanism in read-only scenarios

The leader can change in a read-only scenario. If ODP does not refresh the location cache, requests will be sent to the new leader, which does not meet the expectation. Based on the new leader change feedback mechanism, if a read-only address is used, the current OBServer node includes a key-value pair in the OK packet to notify ODP whether it is the primary node. The following cases exist:

* The current OBServer node has no replica.

* Part or all of the involved replicas are on the current OBServer node.

   * ALL FOLLOWER

   * ALL LEADER

   * PART LEADER/PART FOLLOWER

If the current OBServer node has no replica, ODP actively refreshes the location cache. If the replicas on the current OBServer node are all leaders and ODP considers that it has selected a follower, ODP actively refreshes the location cache to avoid sending read-only requests to the leader.

### Compatibility changes

#### Parameter changes

| Parameter | Change type | Change description |
|----------|----------|-----------|
| connection_diagnosis_option | New | You can enable the connection diagnostics feature by using a bit. For more information, see [connection_diagnosis_option](../../../400.configuration-management/200.dynamically-effective/252.connection-diagnosis-option.md).  |
| enable_connection_diagnosis | Deprecated | This parameter is replaced by `connection_diagnosis_option`.  |
| ssl_attributes | Change | The `min_tls_version` parameter is added to configure the TLS version for SSL connections. For more information, see [ssl_attributes](../../../400.configuration-management/200.dynamically-effective/2447.ssl_attributes.md).  |
| enable_binlog_service | Deprecated | N/A |

### Supported OceanBase Database versions

ODP supports OceanBase Database V4.x and OceanBase Database V3.x and lower. The recommended ODP version varies based on the OceanBase Database version.

* For OceanBase Database V3.x and lower, ODP V3.2.11 is recommended.

* For OceanBase Database V4.x, observe the following rules:

   * If new features are required, ODP V4.2.2 is recommended.

   * If new features are not required, ODP V4.2.1 (an LTS version) is recommended.

### Bug fixes

* Fixed the issue where the memory of ODP is used up due to a memory leak caused by connection diagnostics.

* Fixed the issue that a `binlog` request is disconnected when its execution time exceeds the expiration time of the cluster information stored in ODP.

* Fixed the issue where the connection to the binlog service fails occasionally after the high availability feature is enabled.

* Fixed the issue where disconnection occurs when an invalid port such as `*` or `0` is specified in IP address-based routing.
